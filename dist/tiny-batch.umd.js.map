{"version":3,"file":"tiny-batch.umd.js","sources":["../src/schedulers.ts","../src/queue.ts","../src/index.ts"],"sourcesContent":["import { Scheduler } from \"./types\";\n\n/**\n * Queues a flush in the microtask queue at the first call.\n */\nexport const microtaskScheduler = (): Scheduler => {\n  return (queue, flush) => {\n    if (queue.length === 1) {\n      queueMicrotask(flush);\n    }\n  };\n};\n\n/**\n * Flushes every given ms, regardless of the queue.\n */\nexport const intervalScheduler = (ms: number): Scheduler & { stop(): void } => {\n  let timerId: ReturnType<typeof setInterval>;\n  const fn: Scheduler & { stop(): void } = (queue, flush) => {\n    if (queue.length === 1) {\n      timerId = setInterval(flush, ms);\n    }\n  };\n  fn.stop = () => {\n    clearInterval(timerId);\n  };\n\n  return fn;\n};\n\n/**\n * Waits the given amount of ms after the first call to flush.\n */\nexport const timeoutScheduler = (ms: number): Scheduler & { stop(): void } => {\n  let timerId: ReturnType<typeof setTimeout>;\n  const fn: Scheduler & { stop(): void } = (queue, flush) => {\n    if (queue.length === 1) {\n      timerId = setTimeout(flush, ms);\n    }\n  };\n  fn.stop = () => {\n    clearTimeout(timerId);\n  };\n\n  return fn;\n};\n\n/**\n * Flushes after the given amount of calls.\n * @param max\n */\nexport const amountScheduler = (max: number): Scheduler => {\n  return (queue, flush) => {\n    if (queue.length === max) {\n      flush();\n    }\n  };\n};\n","import { Reject, Resolve, Resolver } from \"./types\";\n\nexport class Queue<Args, Result> {\n  readonly args: Args[] = [];\n  readonly resolvers: Resolver<Result>[] = [];\n\n  add(args: Args, resolve: Resolve<Result>, reject: Reject): void {\n    this.args.push(args);\n    this.resolvers.push({ resolve, reject });\n  }\n\n  reset(): { args: Args[]; resolvers: Resolver<Result>[] } {\n    const args = this.args.splice(0);\n    const resolvers = this.resolvers.splice(0);\n\n    return { args, resolvers };\n  }\n\n  isEmpty(): boolean {\n    return this.args.length === 0;\n  }\n\n  get length(): number {\n    return this.args.length;\n  }\n}\n","import { AddToBatch, ExecuteBatch, Scheduler } from \"./types\";\nimport { microtaskScheduler } from \"./schedulers\";\nimport { Queue } from \"./queue\";\n\nexport * from \"./schedulers\";\nexport * from \"./types\";\n\nexport function tinybatch<Args extends unknown[], Result = void>(\n  callback: ExecuteBatch<Args, Result>,\n  scheduler: Scheduler = microtaskScheduler(),\n): AddToBatch<Args, Result> {\n  const queue = new Queue<Args, Result>();\n\n  const fn: AddToBatch<Args, Result> = (...args) => {\n    return new Promise((resolve, reject) => {\n      queue.add(args, resolve, reject);\n\n      scheduler(queue.args, fn.flush);\n    });\n  };\n\n  fn.queue = queue;\n  fn.scheduler = scheduler;\n  fn.flush = async () => {\n    if (queue.isEmpty()) {\n      return;\n    }\n\n    const { args, resolvers } = queue.reset();\n    const results = (await callback(args)) ?? [];\n\n    for (let i = 0; i < resolvers.length; i++) {\n      const { resolve, reject } = resolvers[i];\n      const result = results[i];\n\n      if (result instanceof Error) {\n        reject(result);\n      } else {\n        resolve(result);\n      }\n    }\n  };\n\n  return fn;\n}\n\nexport default tinybatch;\n"],"names":["microtaskScheduler","queue","flush","length","queueMicrotask","intervalScheduler","ms","timerId","fn","setInterval","stop","clearInterval","timeoutScheduler","setTimeout","clearTimeout","amountScheduler","max","Queue","args","resolvers","_proto","prototype","add","resolve","reject","push","reset","splice","isEmpty","_createClass","key","get","tinybatch","callback","scheduler","_arguments","arguments","Promise","slice","call","_queue$reset","then","results","i","_resolvers$i","result","Error","e"],"mappings":"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"}